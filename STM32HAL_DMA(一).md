# STM32HAL库开发学习——DMA直接存储区访问（一）

基于野火霸道V2——STM32F103ZET6

## 一.DMA基本介绍

+ MDA：直接存储器存取，单片机外设之一，用于搬数据，但是不占用CPU，即在搬数据过程中，CPU可以做其他的事情，类似多线程

+ DMA数据传输支持从外设到存储器、从存储器到外设或者从存储器到存储器，这里的存储器可以是SRAM或者FLASH

+ DMA控制器包括DMA1和DMA2，其中DMA1有七个通道，DMA2有5个通道

## 二.DMA功能框图

1. DMA请求：如果外设想要通过DMA来传输数据，必须先给DMA控制器发送DMA请求，DMA收到请求信号之后，控制器会给一个应答信号，当外设应答后且DMA收到应答信号后，DMA的传输就会开始，直到传输结束

2. 通道：DMA有12个可编程的通道，其中DMA1有7个，DMA2有5个，每个通道对应不同的外设请求。虽然每个通道可以接收不同的外设请求，但是同一时间只能接收一个，不能同时接收多个。具体可见DMA请求映像表

3. 仲裁器：当发生多个DMA通道请求时，意味着先后相应处理的顺序问题，这一部分由仲裁器管理。仲裁器管理DMA通道请求分为两个部分，第一阶段为软件阶段，可以在DMA_CCRx寄存器中进行设置，有：非常高，高，中，低四个优先级。第二阶段为硬件阶段，如果两个或两个以上的DMA通道请求设置的优先级一样，则他们的优先级取决于通道编号，编号越低，优先级越高。（在大容量和互联型产品中，DMA1控制器的优先级高于DMA2控制器的优先级）

## 三.数据配置

### 1.配置数据搬运方向

DMA传输数据的方向有三个：从外设到存储器，从存储器到外设，从存储器到存储器。具体的方向由DMA_CCR位4 DIR来配置：0 表示从外设到存储器，1 表示从存储器到外设。这里面涉及到的外设地址由 DMA_CPAR 配置，存储器地址由 DMA_CMAR配置。

+ 外设到存储器：当我们使用从外设到存储器传输时，以 ADC 采集为例。DMA 外设寄存器的地址对应的就是ADC数据寄存器的地址，DMA存储器的地址就是我们自定义的变量（用来接收存储ADC采集的数据）的地址。方向我们设置外设为源地址。

+ 存储器到外设：当我们使用从存储器到外设传输时，以串口向电脑端发送数据为例。DMA外设寄存器的地址对应的就是串口数据寄存器的地址，DMA存储器的地址就是我们自定义的变量（相当于一个缓冲区，用来存储通过串口发送到电脑的数据）的地址。方向我们设置外设为目标地址。

+ 存储器到存储器：当我们使用从存储器到存储器传输时，以内部 FLASH 向内部 SRAM 复制数据为例。DMA 外设寄存器的地址对应的就是内部 FLASH（我们这里把内部 FALSH 当作一个外设来看）的地址，DMA 存储器的地址就是我们自定义的变量（相当于一个缓冲区，用来存储来自内部 FLASH 的数据）的地址。方向我们设置外设（即内部 FLASH）为源地址。跟上面两个不一样的是，这里需要把 DMA_CCR 位 14：MEM2MEM：存储器到存储器模式配置为 1，启动 M2M 模式。（未学习，后续验证）

## 2.配置要传输的数据数量，以及单位类型

（以串口向电脑发送数据为例）

+ 要想数据传输正确，源和目标地址存储的数据宽度还必须一致，串口数据寄存器是8位的，所以我们定义的要发送的数据也必须是8位。外设的数据宽度由DMA_CCR的PSIZE[1:0]配置，可以是 8/16/32 位，存储器的数据宽度由 DMA_CCR 的 MSIZE[1:0]配置，可以是 8/16/32 位。

+ 在 DMA 控制器的控制下，数据要想有条不紊的从一个地方搬到另外一个地方，还必须正确设置两边数据指针的增量模式。外设的地址指针由DMA_CCRx的PINC配置，存储器的地址指针由MINC配置。以串口向电脑发送数据为例，要发送的数据很多，每发送完一个，那么存储器的地址指针就应该加 1，而串口数据寄存器只有一个，那么外设的地址指针就固定不变。具体的数据指针的增量模式由实际情况决定。

## 3.配置传输完成的标志位（也可以使用中断方式）

+ 数据什么时候传输完成，我们可以通过查询标志位或者通过中断的方式来鉴别。每个DMA 通道在DMA传输过半、传输完成和传输错误时都会有相应的标志位，如果使能了该类型的中断后，则会产生中断。有关各个标志位的详细描述请参考DMA中断状态寄存器DMA_ISR的详细描述。

+ 传输完成还分两种模式，是一次传输还是循环传输。一次传输，即是传输一次之后就停止，要想再传输的话，必须关断DMA使能后再重新配置后才能继续传输。循环传输则是一次传输完成之后又恢复第一次传输时的配置循环传输，不断的重复。具体的由DMA_CCR寄存器的CIRC循环模式位控制。

## 四.小结

学习了DMA的基本原理，下一步将会学习DMA的初始化以及几种DMA传输模式的实验
